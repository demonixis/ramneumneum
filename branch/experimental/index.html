<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Ram Neum Neum</title>
<link href="http://fonts.googleapis.com/css?family=Gochi+Hand" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="css/styles.css" media="all" type="text/css" />
</head>
<body>
	<div id="game">
		<canvas id="gameCanvas" width="800" height="600"></canvas>
		
		
	</div>
	<script src="js/vendor/jaws.js"></script>
	<script src="js/vendor/THREEx.js"></script>
	<script src="js/Neum.Constants.js"></script>
	<script src="js/Neum.Helpers.js"></script>
	<script src="js/Neum.Context.js"></script>
	<script src="js/Neum.Player.js"></script>
	<script src="js/Neum.Enemy.js"></script>
	<script>
		(function() {
			function PlayState() {
				// Joueurs & monstres
				var player = new Neum.Player(jaws.width / 2, jaws.width / 2);
				var enemyList = new Neum.EnemyList();

				// HUD
				var scoreBg = new jaws.Sprite({x : 15, y : 15, image : Neum.Constants.IMG_SCORE_BG});
				var timerSprite = new jaws.Sprite({x : 20, y : 490, image : Neum.Constants.IMG_TIMER, scale:0.25});
				var timerTimeSprite = new jaws.Sprite({x : 50, y : 330, image : Neum.Constants.IMG_TIME_TIMER, scale:0.25, anchor:"center"});
				var background =  new jaws.Sprite({x : 0, y : 0, image : Neum.Constants.IMG_BACKGROUND_1 });
				
				// Variables générales
				var viewport, scoreSprite;

				// Variables timer
				var timer = 0, 
				timerSpawn = 0,
				timerCounter = 0;
				
				// Pour debug
				var mouseRect = new jaws.Rect(50, 50, 8, 8);
				
				this.setup = function() {
					jaws.preventDefaultKeys(["z", "q", "s", "d", "up", "down", "left", "right", "space"]);
					blocks = new jaws.SpriteList();
					var world = new jaws.Rect(0, 0, 800, 600);
					/*viewport = new jaws.Viewport({
						max_x : world.width,
						max_y : world.height
					});*/
					
					player.setup();

					jaws.width = world.width;
					jaws.height = world.height;

					// Initialisation des timers
					Neum.Context.durationHelper.initializeTimer();
					Neum.Context.score = 0;
					timerCounter = 0;
					timer = Neum.Constants.GAME_DURATION;

					// On ajoute déjà un monstre
					enemyList.addEnemy(Neum.RandomHelper(1, 3));					
				}

				this.update = function() {

					//player.setImage(player.anim_default.next());
					if (jaws.pressed("left") || jaws.pressed("q")) {
						player.addX(-player.getSpeed());
						//player.setImage(player.anim_left.next());
					}
					if (jaws.pressed("right") || jaws.pressed("d")) {
						player.addX(player.getSpeed());
						//player.setImage(player.anim_right.next())
					}
					if (jaws.pressed("up") || jaws.pressed("z")) {
						player.addY(-player.getSpeed());
						//player.setImage(player.anim_up.next())
					}
					if (jaws.pressed("down") || jaws.pressed("s")) {
						player.addY(player.getSpeed());
						//player.setImage(player.anim_down.next())
					}

					if (Neum.Context.mouseHelper.clicked || jaws.pressed("space")) {
						player.shoot();
					}
					
					player.update();
					
					mouseRect.x = Neum.Context.mouseHelper.x;
					mouseRect.y = Neum.Context.mouseHelper.y;
					
					enemyList.update();
					enemyList.checkCollideWithPlayer(player.getSprite());
					enemyList.checkCollideWithBullets(player.bulletList);

					var elapsedTime = Neum.Context.durationHelper.getElapsedTime();
					timer -= elapsedTime;

					timerCounter += elapsedTime;
					if(timerCounter >= 1000){
						timerCounter = 0;
						timerTimeSprite.angle -= 1.2857;
					}
					
					if(timer < 0){
						// Fin de la partie
						jaws.switchGameState(GameOverState);
					}

					// Timer de spawn des monstres
					timerSpawn += elapsedTime;
					if (timerSpawn >= 250) {
						timerSpawn = 0;
						enemyList.addEnemy(Neum.RandomHelper(1, 3));
					}

					player.forceInsideCanvas();
				}

				this.draw = function() {
					jaws.clear();
					background.draw();
					
					//viewport.apply(function() {
	
					player.draw();
					enemyList.draw();
					//});
					
					mouseRect.draw();
					
					jaws.context.textAlign = "center";
					jaws.context.font = "bold 45px 'Gochi Hand'";
					jaws.context.fillStyle = "#4500fe";
					jaws.context.fillText(timer, jaws.width / 2, 100);

					// HUD
					scoreBg.draw();
					var menuAngle = Neum.Context.geomHelper.degreeToRadian(6.83);
					jaws.context.rotate(-menuAngle);
					jaws.context.font = "bold 25px 'Gochi Hand'";
					jaws.context.fillText('Score : ' , 80, 65);
					jaws.context.fillText(Neum.Context.score, 150, 65)
					jaws.context.rotate(menuAngle);
					
					timerSprite.draw();
					
					// Mask (The)
					jaws.context.save();
					jaws.context.strokeStyle = "transparent";
					jaws.context.arc(50, 530, 30, 0, Math.PI*2, false);
					jaws.context.clip();
					
					timerTimeSprite.draw();
					jaws.context.restore();
					
				}
			}

			function MenuState() {
				var menuItems = [ "Jouer", "Highscores", "DLC" ];
				var menuHelper = new Neum.MenuHelper(menuItems);
				var background = new jaws.Sprite({x: 0, y: 0, image: Neum.Constants.IMG_HOME_BG});
				var foreground = new jaws.Sprite({x: 0, y: 0, image: Neum.Constants.IMG_HOME_FG});
				var star = new jaws.Sprite({x: 220,
					y: 150,
					image: Neum.Constants.IMG_HOME_STAR,
					anchor: "center"});

				this.setup = function() {
					jaws.preventDefaultKeys(["z", "q", "s", "d", "space"]);

					jaws.on_keydown([ "down" ], function(e) {
						menuHelper.update(1);
					});
					
					jaws.on_keydown([ "up" ], function(e) {
						menuHelper.update(-1);
					});

					jaws.on_keydown([ "space", "enter" ], onValidate);
				}

				this.update = function(){
					star.angle++;
				}
				
				function onValidate(event) {
					switch (menuHelper.getIndex()) {
					case 0:
						jaws.switchGameState(PlayState);
						break;
					case 1:
						break;
					case 2:
						break;
					}
				}

				this.draw = function() {
					jaws.context.clearRect(0, 0, jaws.width, jaws.height);
					
					background.draw();
					star.draw();
					foreground.draw();
					
					jaws.context.textAlign = "center";
					jaws.context.fillStyle = "#4500fe";

					jaws.context.font = "bold 45px 'Gochi Hand'";

					var menuAngle = Neum.Context.geomHelper.degreeToRadian(6.83);
					jaws.context.rotate(-menuAngle);
					for ( var i = 0, l = menuItems.length; i < l; i++) {
						var index = menuHelper.getIndex();
						jaws.context.fillStyle = (i == index) ? "#FD9705"
								: "#FD5BDD";
						jaws.context.fillText(menuItems[i], 545, 415 + i * 90);
					}
					jaws.context.rotate(menuAngle);
				}
			}

			function GameOverState() {
				var background = new jaws.Sprite({x:0, y: 0, image:Neum.Constants.IMG_GAME_OVER});
				var cloud = new jaws.Sprite({x:490, y: 200, image:Neum.Constants.IMG_GAME_OVER_CLOUD, scale:0.25, anchor:"center"});
				
				var startY = 234;
				var startScale = 0.5;
				
				var max;
				var cloudScale;
				var cloudPos;
				var alpha;
				this.setup = function() {
					jaws.preventDefaultKeys(["z", "q", "s", "d", "space"]);
					cloudPos = 234;
					cloudDir = -1;
					max = cloudPos + 20;
					cloudScale = startScale;
					alpha = 1;
				}

				this.update = function() {
					if(jaws.pressed("enter")){
						jaws.start(MenuState);
					}
					
					cloudPos += cloudDir;
					if(cloudPos >= max){
						cloudPos = -1;
						cloudScale = 0.5;
					}
					
					if(alpha < 0){
						cloudScale = startScale;
						cloud.scaleTo(startScale);
						cloudPos = startY;
						cloud.y = startY;
						alpha = 1;
						cloud.alpha = 1;
					}else if(cloudScale > 10){
						alpha-= 0.01;
						cloud.alpha = alpha;
					}else{
						cloudScale += 0.05;
						cloud.scaleTo(cloudScale);
						cloud.y = cloudPos;
					}
				}
				
				this.draw = function() {
					jaws.context.clearRect(0, 0, jaws.width, jaws.height);
					
					background.draw();
					cloud.draw();
					
					jaws.context.textAlign = "center";
					jaws.context.fillStyle = "#FF0000";

					jaws.context.font = "bold 35px 'Gochi Hand'";
					
					jaws.context.font = "bold 55px 'Gochi Hand'";
					jaws.context.fillText(Neum.Context.score + " points", jaws.width - 150, jaws.height - 25);
					
// 					jaws.context.font = "bold 20px 'Gochi Hand'";
// 					jaws.context.fillText("Appuyez sur ESPACE pour retourner au menu", jaws.width / 2, jaws.height - 25);
				}
			}
			
			function GameFinishedState(){
				this.setup = function() {
					jaws.preventDefaultKeys(["z", "q", "s", "d", "space"]);
				}

				this.update = function() {
					if(jaws.pressed("space")){
						jaws.start(MenuState);
					}					
				}
				
				this.draw = function() {
					jaws.context.clearRect(0, 0, jaws.width, jaws.height);
					jaws.context.textAlign = "center";
					jaws.context.font = "bold 65px 'Gochi Hand'";
					jaws.context.fillStyle = "#4500fe";
					jaws.context.fillText("Mission accomplie!", jaws.width / 2, 100);


					jaws.context.font = "bold 25px 'Gochi Hand'";
					jaws.context.fillText("Les gâteaux ont tous bien été décorés", jaws.width / 2, 150);
					
					jaws.context.font = "bold 35px 'Gochi Hand'";
					jaws.context.fillText("- Score -", jaws.width / 2, 250);
					
					jaws.context.font = "bold 55px Consolas";
					jaws.context.fillText(score, jaws.width / 2, jaws.height / 2);
					
					
					jaws.context.font = "bold 20px 'Gochi Hand'";
					jaws.context.fillText("Appuyez sur ESPACE pour retourner au menu", jaws.width / 2, jaws.height - 25);
				}
			}

			function launchGame() {
				jaws.start(PlayState, {fps: 60});
			}
			 
			window.onload = function() {
				jaws.assets.add([ 
					Neum.Constants.IMG_ANIM_CUISTOT,
					Neum.Constants.IMG_ANIM_LARDON,
					Neum.Constants.IMG_ANIM_MACARON,
					Neum.Constants.IMG_ANIM_PAINEPICE,
					Neum.Constants.IMG_PLAYER,
					Neum.Constants.IMG_BULLET,
					Neum.Constants.IMG_ENEMY1,
					Neum.Constants.IMG_ENEMY2,
					Neum.Constants.IMG_ENEMY3,
					Neum.Constants.IMG_HOME_STAR,
					Neum.Constants.IMG_HOME_BG,
					Neum.Constants.IMG_HOME_FG,
					Neum.Constants.IMG_SCORE_BG,
					Neum.Constants.IMG_TIMER,
					Neum.Constants.IMG_TIME_TIMER,
					Neum.Constants.IMG_BACKGROUND_1,
					Neum.Constants.IMG_GAME_OVER,
					Neum.Constants.IMG_GAME_OVER_CLOUD
				 ]);
				jaws.start(PlayState, {fps: 60});
			}
		})();
	</script>
</body>
</html>
